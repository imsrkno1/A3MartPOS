{% extends "base.html" %}

{% block title %}Billing - {{ super() }}{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6">

    <div class="lg:w-3/5 bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Bill</h2>

        <div class="mb-4 relative"> {# Added relative positioning for absolute search results #}
             <label for="billing_product_search" class="block text-sm font-medium text-gray-700 mb-1">Add Product (Name/Barcode/SKU)</label>
             <div class="flex gap-2">
                 <input type="text" id="billing_product_search" class="flex-grow shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md py-2 px-3" placeholder="Scan barcode or search...">
                 <button id="add_product_manual_btn" type="button" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add</button>
             </div>
             <div id="billing-search-results" class="mt-1 border border-gray-300 rounded-md shadow-sm max-h-40 overflow-y-auto bg-white hidden z-10 absolute w-full lg:w-auto left-0 right-0"> {# Adjusted positioning #}
                 {# Search results populated by JavaScript #}
             </div>
        </div>

        <div class="overflow-x-auto mb-4 max-h-96 overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0 z-0"> {# Lower z-index than search results #}
                    <tr>
                        {# ** MODIFIED: Adjusted widths and added Discount % header ** #}
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/6">Product</th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Qty</th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Price</th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Discount %</th> {# <-- New Header #}
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Total</th>
                        <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody id="billing-items-body" class="bg-white divide-y divide-gray-200">
                    <tr id="billing-no-items-row">
                         {# ** MODIFIED: Increased colspan ** #}
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 italic">Scan or search to add items.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="border-t border-gray-200 pt-4 space-y-2">
            <div class="flex justify-between text-sm font-medium text-gray-700">
                <span>Subtotal</span>
                <span id="billing-subtotal">₹0.00</span>
            </div>
             <div class="flex justify-between text-sm font-medium text-gray-700">
                <span>Discount</span>
                {# Add input for manual discount later if needed #}
                <span id="billing-discount" class="text-red-600">- ₹0.00</span>
            </div>
             <div class="flex justify-between text-lg font-bold text-gray-900 border-t border-dashed pt-2 mt-2">
                <span>Total</span>
                <span id="billing-total">₹0.00</span>
            </div>
        </div>
    </div>

    <div class="lg:w-2/5 space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-md relative"> {# Added relative positioning #}
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Customer</h3>
             <div class="mb-3">
                 <label for="customer_search" class="block text-sm font-medium text-gray-700 mb-1">Search Customer (Name/Phone/Email)</label>
                 <input type="text" id="customer_search" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md py-2 px-3" placeholder="Search or leave blank for Walk-in">
                  <div id="customer-search-results" class="mt-1 border border-gray-300 rounded-md shadow-sm max-h-40 overflow-y-auto bg-white hidden z-10 absolute w-full left-0 right-0"> {# Adjusted positioning #}
                     {# Customer search results populated by JavaScript #}
                 </div>
             </div>
             <div id="selected-customer-info" class="text-sm text-gray-600 hidden mt-2"> {# Added margin top #}
                 Selected: <span id="selected-customer-name" class="font-medium"></span>
                 <button id="remove-customer-btn" type="button" class="ml-2 text-red-500 hover:text-red-700 text-xs">[Remove]</button>
             </div>
             <div class="mt-2">
                 <a href="{{ url_for('customers.add_customer') }}" target="_blank" class="text-sm text-blue-600 hover:underline">Add New Customer</a>
                 {# Ideally, use a modal for adding customer without leaving page #}
             </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Payment</h3>
            <div class="space-y-3">
                <label for="payment_method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                <select id="payment_method" name="payment_method" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option>Cash</option>
                    <option>Card</option>
                    <option>UPI</option>
                    <option>Other</option>
                </select>
                {# Add fields for Amount Tendered / Change Due later if needed #}
            </div>
             <div class="mt-4">
                 <label for="billing_notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                 <textarea id="billing_notes" name="billing_notes" rows="2" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md py-2 px-3" placeholder="Optional notes for this sale"></textarea>
             </div>
            <div class="mt-6">
                <button id="process-sale-btn" type="button" class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-lg font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" disabled>
                    Process Sale
                </button>
            </div>
        </div>
    </div>

</div>

<div id="receipt-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Sale Receipt</h3>
            <div class="mt-2 px-7 py-3">
                <pre id="receipt-content" class="text-xs text-left whitespace-pre-wrap font-mono bg-gray-100 p-2 rounded border overflow-x-auto max-h-80"></pre> {# Use pre for formatted text #}
            </div>
            <div class="items-center px-4 py-3">
                <button id="print-receipt-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Print Receipt
                </button>
                <button id="close-receipt-modal-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Element References ---
        const productSearchInput = document.getElementById('billing_product_search');
        const productSearchResultsDiv = document.getElementById('billing-search-results');
        const addProductManualBtn = document.getElementById('add_product_manual_btn');
        const itemsTableBody = document.getElementById('billing-items-body');
        const noItemsRow = document.getElementById('billing-no-items-row');
        const subtotalCell = document.getElementById('billing-subtotal');
        const discountCell = document.getElementById('billing-discount');
        const totalCell = document.getElementById('billing-total');
        const customerSearchInput = document.getElementById('customer_search');
        const customerSearchResultsDiv = document.getElementById('customer-search-results');
        const selectedCustomerInfoDiv = document.getElementById('selected-customer-info');
        const selectedCustomerNameSpan = document.getElementById('selected-customer-name');
        const removeCustomerBtn = document.getElementById('remove-customer-btn');
        const paymentMethodSelect = document.getElementById('payment_method');
        const notesTextarea = document.getElementById('billing_notes');
        const processSaleButton = document.getElementById('process-sale-btn');
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        // Receipt Modal Elements
        const receiptModal = document.getElementById('receipt-modal');
        const receiptContentPre = document.getElementById('receipt-content');
        const printReceiptBtn = document.getElementById('print-receipt-btn');
        const closeReceiptModalBtn = document.getElementById('close-receipt-modal-btn');


        // --- State Variables ---
        let billingItems = []; // Array to hold { product_id, name, quantity, price_at_sale, discount_percent, discount_applied, stock }
        let selectedCustomerId = null;
        let productSearchTimeout;
        let customerSearchTimeout;

        // --- Utility Functions ---
        function formatCurrency(amount) {
            return `₹${parseFloat(amount || 0).toFixed(2)}`;
        }

        // --- Product Search & Add Logic ---
        function fetchAndDisplayProducts(query) {
             if (query.length < 1) {
                productSearchResultsDiv.innerHTML = '';
                productSearchResultsDiv.classList.add('hidden');
                return;
            }
            productSearchResultsDiv.classList.remove('hidden');
            productSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">Searching...</div>';

            clearTimeout(productSearchTimeout);
            productSearchTimeout = setTimeout(() => {
                fetch(`{{ url_for('inventory.search_products_api') }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        productSearchResultsDiv.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(product => {
                                const div = document.createElement('div');
                                div.classList.add('p-2', 'text-sm', 'cursor-pointer', 'hover:bg-gray-100');
                                div.textContent = product.text;
                                div.addEventListener('click', () => addBillingItem(product));
                                productSearchResultsDiv.appendChild(div);
                            });
                        } else {
                            productSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">No products found.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching products:', error);
                        productSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-red-500">Error searching.</div>';
                    });
            }, 150);
        }

        productSearchInput.addEventListener('input', () => fetchAndDisplayProducts(productSearchInput.value.trim()));
        addProductManualBtn.addEventListener('click', () => fetchAndDisplayProducts(productSearchInput.value.trim()));

        // --- Add Item to Billing Table ---
        function addBillingItem(productData) {
            const productId = productData.id;
            const existingItemIndex = billingItems.findIndex(item => item.product_id === productId);
            const availableStock = parseInt(productData.stock_quantity || 0);
            const discountPercent = parseFloat(productData.discount_percent || 0); // Get discount %
            const sellingPrice = parseFloat(productData.selling_price || 0);

            if (existingItemIndex > -1) {
                // Item exists, increment quantity if stock allows
                const currentQuantity = billingItems[existingItemIndex].quantity;
                if (availableStock > currentQuantity) {
                    billingItems[existingItemIndex].quantity++;
                    // Recalculate discount for the new quantity
                    billingItems[existingItemIndex].discount_applied = calculateItemDiscount(
                        billingItems[existingItemIndex].quantity,
                        billingItems[existingItemIndex].price_at_sale,
                        billingItems[existingItemIndex].discount_percent // Use stored percent
                    );
                } else {
                    alert(`Cannot add more ${productData.name}. Only ${availableStock} available in stock.`);
                    clearProductSearch();
                    return;
                }
            } else {
                // New item, add if stock allows
                 if (availableStock < 1) {
                    alert(`Cannot add ${productData.name}. Out of stock.`);
                    clearProductSearch();
                    return;
                }
                // Calculate initial discount amount for quantity 1
                const initialDiscount = calculateItemDiscount(1, sellingPrice, discountPercent);

                billingItems.push({
                    product_id: productId,
                    name: productData.name,
                    quantity: 1,
                    price_at_sale: sellingPrice,
                    discount_percent: discountPercent, // Store the percentage
                    discount_applied: initialDiscount, // Store the calculated amount
                    stock: availableStock
                });
            }
            renderBillingTable();
            clearProductSearch();
        }

        // --- Calculate Item Discount ---
        function calculateItemDiscount(quantity, price, discountPercent) {
            if (discountPercent <= 0 || price <= 0 || quantity <= 0) {
                return 0.0;
            }
            const itemSubtotal = quantity * price;
            const discountAmount = itemSubtotal * (discountPercent / 100);
            return parseFloat(discountAmount.toFixed(2)); // Return calculated discount amount, rounded
        }

        function clearProductSearch() {
             productSearchInput.value = '';
             productSearchResultsDiv.innerHTML = '';
             productSearchResultsDiv.classList.add('hidden');
             productSearchInput.focus();
        }

        // --- Render Billing Table ---
        function renderBillingTable() {
            itemsTableBody.innerHTML = '';
            if (billingItems.length === 0) {
                if (noItemsRow) itemsTableBody.appendChild(noItemsRow);
            } else {
                const existingNoItemsRow = itemsTableBody.querySelector('#billing-no-items-row');
                if (existingNoItemsRow) existingNoItemsRow.remove();

                billingItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    // Calculate item total *before* discount for display row
                    const itemDisplayTotal = item.quantity * item.price_at_sale;

                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <input type="number" value="${item.quantity}" min="1" max="${item.stock}" step="1" class="billing-quantity-input shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-16 sm:text-sm border-gray-300 rounded-md py-1 px-2" data-index="${index}">
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <input type="number" value="${item.price_at_sale.toFixed(2)}" min="0" step="0.01" class="billing-price-input shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-24 sm:text-sm border-gray-300 rounded-md py-1 px-2" data-index="${index}">
                        </td>
                        {# ** MODIFIED: Changed discount display to an input field ** #}
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                             <input type="number" value="${item.discount_percent.toFixed(2)}" min="0" max="100" step="0.01" class="billing-discount-percent-input shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-20 sm:text-sm border-gray-300 rounded-md py-1 px-2" data-index="${index}">
                        </td>
                        <td class="billing-item-total px-4 py-2 whitespace-nowrap text-sm font-medium">${formatCurrency(itemDisplayTotal)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-center text-sm">
                            <button type="button" class="billing-remove-item-btn text-red-600 hover:text-red-800" data-index="${index}">Remove</button>
                        </td>
                    `;
                    itemsTableBody.appendChild(row);
                });
            }
            updateSummary();
            attachTableEventListeners(); // Re-attach listeners after re-render
        }

        // --- Attach Listeners to Table Inputs/Buttons ---
        function attachTableEventListeners() {
            document.querySelectorAll('.billing-quantity-input').forEach(input => {
                input.addEventListener('change', handleQuantityChange);
            });
             document.querySelectorAll('.billing-price-input').forEach(input => {
                input.addEventListener('change', handlePriceChange);
            });
             // ** ADDED: Listener for discount percentage input **
             document.querySelectorAll('.billing-discount-percent-input').forEach(input => {
                input.addEventListener('change', handleDiscountPercentChange);
            });
            document.querySelectorAll('.billing-remove-item-btn').forEach(button => {
                button.addEventListener('click', handleRemoveItem);
            });
        }

        // --- Handle Table Input Changes ---
        function handleQuantityChange(event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            let newQuantity = parseInt(input.value);
            const item = billingItems[index];
            if (isNaN(newQuantity) || newQuantity < 1) {
                newQuantity = 1;
                input.value = newQuantity;
            }
            if (newQuantity > item.stock) {
                 alert(`Cannot set quantity to ${newQuantity}. Only ${item.stock} available for ${item.name}.`);
                 newQuantity = item.stock;
                 input.value = newQuantity;
            }
            billingItems[index].quantity = newQuantity;
            // Recalculate discount when quantity changes
            billingItems[index].discount_applied = calculateItemDiscount(
                newQuantity,
                billingItems[index].price_at_sale,
                billingItems[index].discount_percent
            );
            renderBillingTable(); // Re-render to update totals and potentially discount display
        }
         function handlePriceChange(event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            let newPrice = parseFloat(input.value);
             if (isNaN(newPrice) || newPrice < 0) {
                newPrice = 0;
                input.value = newPrice.toFixed(2);
            }
            billingItems[index].price_at_sale = newPrice;
             // Recalculate discount when price changes
            billingItems[index].discount_applied = calculateItemDiscount(
                billingItems[index].quantity,
                newPrice,
                billingItems[index].discount_percent
            );
            renderBillingTable(); // Re-render to update totals
        }

        // ** ADDED: Handler for discount percentage input change **
        function handleDiscountPercentChange(event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            let newDiscountPercent = parseFloat(input.value);

            // Validate percentage (0-100)
            if (isNaN(newDiscountPercent) || newDiscountPercent < 0) {
                newDiscountPercent = 0;
                input.value = newDiscountPercent.toFixed(2);
            } else if (newDiscountPercent > 100) {
                 newDiscountPercent = 100;
                 input.value = newDiscountPercent.toFixed(2);
            }

            // Update the percentage in the billingItems array
            billingItems[index].discount_percent = newDiscountPercent;

            // Recalculate the discount amount based on the new percentage
            billingItems[index].discount_applied = calculateItemDiscount(
                billingItems[index].quantity,
                billingItems[index].price_at_sale,
                newDiscountPercent // Use the newly entered percentage
            );

            // No need to re-render the whole table, just update the summary
            updateSummary();
        }


        // --- Handle Item Removal ---
        function handleRemoveItem(event) {
            const index = parseInt(event.target.dataset.index);
            billingItems.splice(index, 1);
            renderBillingTable();
        }

        // --- Update Summary ---
        function updateSummary() {
            let currentSubtotal = 0;
            let currentDiscount = 0; // This is the total discount amount
            billingItems.forEach(item => {
                currentSubtotal += (item.quantity || 0) * (item.price_at_sale || 0);
                // Accumulate the pre-calculated discount amount for each item
                currentDiscount += (item.discount_applied || 0);
            });
            const currentTotal = currentSubtotal - currentDiscount;
            subtotalCell.textContent = formatCurrency(currentSubtotal);
            discountCell.textContent = `- ${formatCurrency(currentDiscount)}`; // Display total discount amount
            totalCell.textContent = formatCurrency(currentTotal);
            processSaleButton.disabled = billingItems.length === 0;
        }

        // --- Customer Search & Selection ---
         function fetchAndDisplayCustomers(query) {
             if (query.length < 2) {
                customerSearchResultsDiv.innerHTML = '';
                customerSearchResultsDiv.classList.add('hidden');
                return;
            }
            customerSearchResultsDiv.classList.remove('hidden');
            customerSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">Searching...</div>';
            clearTimeout(customerSearchTimeout);
            customerSearchTimeout = setTimeout(() => {
                fetch(`{{ url_for('customers.search_customers_api') }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        customerSearchResultsDiv.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(customer => {
                                const div = document.createElement('div');
                                div.classList.add('p-2', 'text-sm', 'cursor-pointer', 'hover:bg-gray-100');
                                div.textContent = customer.text;
                                div.addEventListener('click', () => selectCustomer(customer));
                                customerSearchResultsDiv.appendChild(div);
                            });
                        } else {
                            customerSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">No customers found.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching customers:', error);
                        customerSearchResultsDiv.innerHTML = '<div class="p-2 text-sm text-red-500">Error searching.</div>';
                    });
            }, 300);
        }
        customerSearchInput.addEventListener('input', () => fetchAndDisplayCustomers(customerSearchInput.value.trim()));
        function selectCustomer(customer) {
            selectedCustomerId = customer.id;
            selectedCustomerNameSpan.textContent = customer.name;
            selectedCustomerInfoDiv.classList.remove('hidden');
            customerSearchInput.value = '';
            customerSearchResultsDiv.classList.add('hidden');
        }
        removeCustomerBtn.addEventListener('click', () => {
            selectedCustomerId = null;
            selectedCustomerInfoDiv.classList.add('hidden');
            selectedCustomerNameSpan.textContent = '';
            customerSearchInput.value = '';
        });

         // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (productSearchInput && !productSearchInput.contains(event.target) && !productSearchResultsDiv.contains(event.target)) {
                productSearchResultsDiv.classList.add('hidden');
            }
             if (customerSearchInput && !customerSearchInput.contains(event.target) && !customerSearchResultsDiv.contains(event.target)) {
                customerSearchResultsDiv.classList.add('hidden');
            }
        });


        // --- Process Sale ---
        processSaleButton.addEventListener('click', function() {
            if (billingItems.length === 0) {
                alert("Cannot process an empty bill.");
                return;
            }
            const saleData = {
                customer_id: selectedCustomerId,
                payment_method: paymentMethodSelect.value,
                notes: notesTextarea.value.trim(),
                items: billingItems.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity,
                    price_at_sale: item.price_at_sale,
                    discount_applied: item.discount_applied // Send calculated discount amount
                }))
            };
            processSaleButton.disabled = true;
            processSaleButton.textContent = 'Processing...';

            fetch("{{ url_for('billing.process_sale') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(saleData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    receiptContentPre.textContent = data.thermal_receipt;
                    receiptModal.classList.remove('hidden');
                    billingItems = [];
                    selectedCustomerId = null;
                    selectedCustomerInfoDiv.classList.add('hidden');
                    customerSearchInput.value = '';
                    notesTextarea.value = '';
                    paymentMethodSelect.value = 'Cash';
                    renderBillingTable();
                } else {
                    alert(`Error: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error processing sale:', error);
                alert('An unexpected network or server error occurred.');
            })
            .finally(() => {
                 processSaleButton.disabled = billingItems.length === 0;
                 processSaleButton.textContent = 'Process Sale';
            });
        });

        // --- Receipt Modal Logic ---
        closeReceiptModalBtn.addEventListener('click', () => {
            receiptModal.classList.add('hidden');
        });

        printReceiptBtn.addEventListener('click', () => {
            const contentToPrint = receiptContentPre.innerHTML;
            const printWindow = window.open('', '_blank', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Print Receipt</title>');
            printWindow.document.write('<style> pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 10pt; } </style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<pre>');
            printWindow.document.write(contentToPrint);
            printWindow.document.write('</pre>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        });


        // --- Initial Setup ---
        updateSummary();
        productSearchInput.focus();

    }); // End DOMContentLoaded

</script>
{% endblock %}